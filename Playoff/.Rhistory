adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
5*326
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,8,15))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 7, timeout_sec = 60) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
options(timeout = 400)
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,8,15))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 7, timeout_sec = 60) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
options(timeout = 400)
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 5, timeout_sec = 120) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
options(timeout = 400)
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 5, timeout_sec = 300) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 5, timeout_sec = 300) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
safe_read_html <- function(url, retries = 5, wait = 5, timeout_sec = 300) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
#Loop and Webscrape for All Teams
options(timeout_seconds=5000)
options(timeout_seconds=5000)
safe_read_html <- function(url, retries = 5, wait = 7, timeout_sec = 3000) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
#Loop and Webscrape for All Teams
options(timeout_seconds=5000)
safe_read_html <- function(url, retries = 5, wait = 7, timeout_sec = 3000) {
for (i in seq_len(retries)) {
try({
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/118.0"),
timeout(timeout_sec)
)
if (status_code(res) == 200) {
return(read_html(res))
}
}, silent = TRUE)
message("Retry ", i, "/", retries, " after waiting ", wait, "s for ", url)
Sys.sleep(wait)
}
stop("Failed to connect to ", url)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
PERGAME=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
#Sys.sleep(runif(1,3,5))
url <- SCHOOLURLS[i]
page <- read_html(url)
per_game_table <- page %>%
html_element("#all_players_per_game table") %>%
html_table(fill = TRUE)
pergame=per_game_table[,c(-1,-3,-29)]
PERGAME=rbind(PERGAME,pergame)
}
safe_read_html <- function(url, max_tries = 5, wait_seconds = 3, max_wait = 60) {
for (i in seq_len(max_tries)) {
try({
# Send GET request with a realistic User-Agent
res <- GET(
url,
user_agent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36")
)
# Handle 429 Too Many Requests
if (status_code(res) == 429) {
# Check Retry-After header (if present)
retry_after <- as.numeric(headers(res)[["Retry-After"]])
if (is.na(retry_after)) retry_after <- wait_seconds
retry_after <- min(retry_after, max_wait)
message(sprintf("HTTP 429 received. Waiting %d seconds before retrying...", retry_after))
Sys.sleep(retry_after)
next
}
# Successful request
if (status_code(res) == 200) {
page <- read_html(res)
return(page)
} else {
message(sprintf("Attempt %d: Failed with status %d", i, status_code(res)))
Sys.sleep(wait_seconds)
}
}, silent = TRUE)
# Exponential backoff for other errors
Sys.sleep(wait_seconds * i)
}
warning(sprintf("Failed to read URL after %d attempts: %s", max_tries, url))
return(NULL)
}
ADVANCED=NULL
for(i in (1:length(SCHOOLURLS))){
print(i)
url <- SCHOOLURLS[i]
page <- safe_read_html(url)
comments <- page %>% html_nodes(xpath = '//comment()') %>% html_text()
adv_html <- comments[str_detect(comments, "players_advanced")]
adv_page <- read_html(adv_html)
advanced_table <- adv_page %>% html_table(fill = TRUE) %>% .[[1]]
advanced=advanced_table[-13,-c(1,3:6,27)]
ADVANCED=rbind(ADVANCED,advanced)
}
#Code Below Doesn't Work (Uncomment and Check)
TEAMURL=SCHOOLURLS[52]
OUT = read_html(TEAMURL) %>%
html_nodes(css="#players_advanced .left , #players_advanced .right, #players_advanced .center")
PERGAME = OUT[[6]][,c(-1,-5)]
ADVANCED = OUT[[14]][,-c(1,3,4,20,25)]
PLAYERMERGE=inner_join(PERGAME,ADVANCED,by="Player")
Stats_URL="https://www.sports-reference.com/cbb/seasons/women/2025-school-stats.html"
ALL=read_html(Stats_URL) %>%
html_table() %>%
.[[1]]
install.packages("RSelenium")
library(RSelenium)
library(rvest)
library(dplyr)
# Start RSelenium (Chrome)
rD <- rsDriver(browser = "chrome", port = 4545L, chromever = "latest")
install.packages("JavaGD")
library(RSelenium)
library(rvest)
library(dplyr)
# Start RSelenium (Chrome)
rD <- rsDriver(browser = "chrome", port = 4545L, chromever = "latest")
library(RSelenium)
library(rvest)
library(dplyr)
# Start RSelenium (Chrome)
rD <- rsDriver(browser = "chrome", port = 4545L, chromever = "latest")
library(DT)
library(tidyverse)
library(readxl)
library(plyr)
setwd("D:/DoctorMario/UNC/STOR 538/STOR538_WEBSITE/Playoff")
Actual=read.csv(file="Actual.csv",fileEncoding="latin1")
Actual$Home=gsub('^.', '', Actual$Home)
Actual$Away=gsub('^.', '', Actual$Away)
Actual[58,2]="Miami Dolphins"
Actual=Actual[,c(1,2,3,5,4,6)]
Actual=dplyr::rename(Actual,Total=Total.Points,Pass=Total.Passing.Yards)
P1=read.csv(file="Predictions_1.csv")
P2=read.csv(file="Predictions_2.csv")
P2[58,2]="Miami Dolphins"
P3=read.csv(file="Predictions_3.csv",fileEncoding="latin1")
P3$Home=gsub('^.', '', P3$Home)
P3$Away=gsub('^.', '', P3$Away)
P3[58,2]="Miami Dolphins"
P4=read.csv(file="Predictions_4.csv")
P5=read.csv(file="Predictions_5.csv")
P5$Home=gsub('^.', '', P5$Home)
P5$Away=gsub('^.', '', P5$Away)
P5[58,2]="Miami Dolphins"
P6=read.csv(file="Predictions_6.csv",fileEncoding="latin1")
P6$Home=gsub('^.', '', P6$Home)
P6$Away=gsub('^.', '', P6$Away)
P6[58,2]="Miami Dolphins"
P7=read.csv(file="Predictions_7.csv")
P8=read.csv(file="Predictions_8.csv")
P8$Home=gsub('^.', '', P8$Home)
P8$Away=gsub('^.', '', P8$Away)
P9=read.csv(file="Predictions_9.csv")
P9$Home=gsub('^.', '', P9$Home)
P9$Away=gsub('^.', '', P9$Away)
P9[58,2]="Miami Dolphins"
SPREAD=join_all(list(dplyr::rename(P1,Spread_1=Spread)[,1:4],
dplyr::rename(P2,Spread_2=Spread)[,1:4],
dplyr::rename(P3,Spread_3=Spread)[,1:4],
dplyr::rename(P4,Spread_4=Spread)[,1:4],
dplyr::rename(P5,Spread_5=Spread)[,1:4],
dplyr::rename(P6,Spread_6=Spread)[,1:4],
dplyr::rename(P7,Spread_7=Spread)[,1:4],
dplyr::rename(P8,Spread_8=Spread)[,1:4],
dplyr::rename(P9,Spread_9=Spread)[,1:4]),
by=c("Week","Home","Away"),type="left")
TOTAL=join_all(list(dplyr::rename(P1,Total_1=Total)[,c(1:3,5)],
dplyr::rename(P2,Total_2=Total)[,c(1:3,5)],
dplyr::rename(P3,Total_3=Total)[,c(1:3,5)],
dplyr::rename(P4,Total_4=Total)[,c(1:3,5)],
dplyr::rename(P5,Total_5=Total)[,c(1:3,5)],
dplyr::rename(P6,Total_6=Total)[,c(1:3,5)],
dplyr::rename(P7,Total_7=Total)[,c(1:3,5)],
dplyr::rename(P8,Total_8=Total)[,c(1:3,5)],
dplyr::rename(P9,Total_9=Total)[,c(1:3,5)]),
by=c("Week","Home","Away"),type="left")
PASS=join_all(list(dplyr::rename(P1,Pass_1=Pass)[,c(1:3,6)],
dplyr::rename(P2,Pass_2=Pass)[,c(1:3,6)],
dplyr::rename(P3,Pass_3=Pass)[,c(1:3,6)],
dplyr::rename(P4,Pass_4=Pass)[,c(1:3,6)],
dplyr::rename(P5,Pass_5=Pass)[,c(1:3,6)],
dplyr::rename(P6,Pass_6=Pass)[,c(1:3,6)],
dplyr::rename(P7,Pass_7=Pass)[,c(1:3,6)],
dplyr::rename(P8,Pass_8=Pass)[,c(1:3,6)],
dplyr::rename(P9,Pass_9=Pass)[,c(1:3,6)]),
by=c("Week","Home","Away"),type="left")
write.csv(dplyr::select(mutate(SPREAD,Actual=Actual$Spread),"Week","Home","Away","Actual",everything()),"SPREAD_class.csv")
write.csv(dplyr::select(mutate(TOTAL,Actual=Actual$Total),"Week","Home","Away","Actual",everything()),"TOTAL_class.csv")
write.csv(dplyr::select(mutate(PASS,Actual=Actual$Pass),"Week","Home","Away","Actual",everything()),"PASS_class.csv")
mae.func=function(prediction,actual){
mean(abs(actual-prediction),na.rm=T)
}
SPREAD.RESULT=apply(SPREAD[,-(1:3)],2,mae.func,actual=Actual$Spread)
SPREAD.RANK=rank(SPREAD.RESULT)
TOTAL.RESULT=apply(TOTAL[,-(1:3)],2,mae.func,actual=Actual$Total)
TOTAL.RANK=rank(TOTAL.RESULT)
PASS.RESULT=apply(PASS[,-(1:3)],2,mae.func,actual=Actual$Pass)
PASS.RANK=rank(PASS.RESULT)
Group = c(1:9)
Class_Results = tibble(Group=Group,
`Spread MAE`=SPREAD.RESULT,
`Spread Rank`=SPREAD.RANK,
`Total MAE`=TOTAL.RESULT,
`Total Rank`=TOTAL.RANK,
`Pass MAE`=PASS.RESULT,
`Pass Rank`=PASS.RANK)
write.csv(Class_Results,"Class_Results.csv",row.names=F)
